# Flatpak manifest for DLSS Updater
# This manifest wraps the Flet-built Linux application
#
# Build process:
# 1. Build with Flet: flet build linux
# 2. Run flatpak-builder with this manifest
#
# Local build (WSL2):
#   uv run flet build linux --project DLSS_Updater --product "DLSS Updater" --org io.github.recol
#   cp -r build/linux/* dist/
#   flatpak-builder --force-clean --repo=repo build-dir io.github.recol.dlss-updater.yml
#   flatpak build-bundle repo DLSS_Updater.flatpak io.github.recol.dlss-updater

app-id: io.github.recol.dlss-updater
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk

command: dlss-updater

finish-args:
  # Display & Graphics (required for Flutter UI)
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --share=ipc

  # Network (for DLSS update checks and downloads)
  - --share=network

  # Filesystem - broad coverage for game directories
  # Read-only access to detect and scan game installations
  - --filesystem=home:ro
  - --filesystem=/mnt:ro
  - --filesystem=/media:ro
  - --filesystem=/run/media:ro
  # Read-write access for app config, cache, and data
  - --filesystem=xdg-config/DLSS-Updater:rw
  - --filesystem=xdg-cache/DLSS-Updater:rw
  - --filesystem=~/.local/share/dlss-updater:create
  # Flet framework cache directory (required for Flet to initialize)
  - --filesystem=~/.flet:create

  # Portal support
  - --talk-name=org.freedesktop.portal.FileChooser

modules:
  - name: dlss-updater
    buildsystem: simple
    build-commands:
      # Install the entire Flet bundle (executable + Flutter libs + Python runtime + site-packages)
      # Flet build creates: dlss_updater, lib/, data/, python3.12/, site-packages/
      - mkdir -p /app/lib/dlss-updater
      - mkdir -p /app/bin
      - cp -r dist/* /app/lib/dlss-updater/
      - chmod +x /app/lib/dlss-updater/dlss_updater
      # Create wrapper script that runs from the bundle directory
      - printf '#!/bin/bash\ncd /app/lib/dlss-updater\nexec ./dlss_updater "$@"\n' > /app/bin/dlss-updater
      - chmod +x /app/bin/dlss-updater
      # Install desktop integration files
      - install -Dm644 io.github.recol.dlss-updater.appdata.xml /app/share/metainfo/io.github.recol.dlss-updater.metainfo.xml
      # Convert CRLF to LF (Windows -> Unix line endings) and install desktop file
      - sed 's/\r$//' flatpak/io.github.recol.dlss-updater.desktop > /tmp/desktop.tmp && install -Dm644 /tmp/desktop.tmp /app/share/applications/io.github.recol.dlss-updater.desktop
      - install -Dm644 appimagex_png.png /app/share/icons/hicolor/256x256/apps/io.github.recol.dlss-updater.png
    sources:
      - type: dir
        path: .
