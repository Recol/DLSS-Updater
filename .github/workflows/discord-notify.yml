name: Discord Release Notification

on:
  release:
    types: [published, edited]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get latest release (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        id: latest_release
        run: |
          RELEASE_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          
          echo "name=$(echo $RELEASE_DATA | jq -r '.name')" >> $GITHUB_OUTPUT
          echo "tag=$(echo $RELEASE_DATA | jq -r '.tag_name')" >> $GITHUB_OUTPUT
          echo "url=$(echo $RELEASE_DATA | jq -r '.html_url')" >> $GITHUB_OUTPUT
          
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_DATA" | jq -r '.body' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            RELEASE_NAME="${{ steps.latest_release.outputs.name }}"
            RELEASE_TAG="${{ steps.latest_release.outputs.tag }}"
            RELEASE_URL="${{ steps.latest_release.outputs.url }}"
            RELEASE_BODY="${{ steps.latest_release.outputs.body }}"
          else
            RELEASE_NAME="${{ github.event.release.name }}"
            RELEASE_TAG="${{ github.event.release.tag_name }}"
            RELEASE_URL="${{ github.event.release.html_url }}"
            RELEASE_BODY="${{ github.event.release.body }}"
          fi
          
          # Use jq to properly escape JSON
          PAYLOAD=$(jq -n \
            --arg name "$RELEASE_NAME" \
            --arg tag "$RELEASE_TAG" \
            --arg url "$RELEASE_URL" \
            --arg body "$RELEASE_BODY" \
            '{content: ("ðŸŽ‰ **New Release Published!**\n\n**" + $name + "** (" + $tag + ")\n" + $url + "\n\n" + $body)}')
          
          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               $DISCORD_WEBHOOK