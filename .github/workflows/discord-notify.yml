name: Discord Release Notification

on:
  release:
    types: [published, edited]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get release data
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/latest" > release.json
          else
            cat > release.json <<'EOF'
          ${{ toJSON(github.event.release) }}
          EOF
          fi
      
      - name: Build Discord payload
        run: |
          cat > filter.jq <<'EOF'
          {
            content: "ðŸŽ‰ **New Release Published!**",
            embeds: [{
              title: .[0].name,
              url: .[0].html_url,
              description: (.[0].body | if length > 4096 then .[0:4093] + "..." else . end),
              color: 5814783,
              fields: [{
                name: "Version",
                value: .[0].tag_name,
                inline: true
              }]
            }]
          }
          EOF
          
          jq --slurp -f filter.jq release.json > payload.json
      
      - name: Send to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" -d @payload.json "$DISCORD_WEBHOOK"
